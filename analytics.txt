<!DOCTYPE html>
<html>
<head>
  </head>
<body>
<div class="container">
    <h1><i class="fa-solid fa-chart-line" style="margin-right: 8px; color: var(--primary-color);"></i> ì„±ê³¼ ë¶„ì„</h1>

    <div class="global-filters card">
        <div class="filter-group">
            <label for="dateRangeFilter">ê¸°ê°„ ì„ íƒ</label>
            <select id="dateRangeFilter" onchange="applyAnalyticsFilters()">
                <option value="7d">ìµœê·¼ 7ì¼</option>
                <option value="30d" selected>ìµœê·¼ 30ì¼</option>
       
          <option value="90d">ì´ë²ˆ ë¶„ê¸°</option>
                <option value="365d">ì§€ë‚œ 1ë…„</option>
            </select>
        </div>
        <div class="filter-group">
             <label for="countryFilter">êµ­ê°€ í•„í„°</label>
            <select id="countryFilter" onchange="applyAnalyticsFilters()">
             
    <option value="all" selected>ì „ì²´ êµ­ê°€</option>
                <option value="jp">ì¼ë³¸ (JP)</option>
                <option value="non_jp">Global (JP ì œì™¸)</option>
            </select>
        </div>
    </div>

    <div id="loader-container">
        <?!= include('loading');
 ?>
    </div>

    <div id="analytics-content" class="initially-hidden">

        <div class="tab-buttons card" style="margin-bottom: 1.5rem; padding: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <button class="tab-button active" onclick="showTab('tab-overview')" data-tab-id="tab-overview">ì¢…í•© ì„±ê³¼</button>
            <button class="tab-button" onclick="showTab('tab-customer')" data-tab-id="tab-customer">ê³ ê° ë¶„ì„</button>
            <button class="tab-button" onclick="showTab('tab-channel')" data-tab-id="tab-channel">ì±„ë„ ë° ë­í‚¹</button>
            <button class="tab-button" onclick="showTab('tab-regional')" data-tab-id="tab-regional" style="display: none;">ì§€ì—­ ì„±ê³¼</button> </div>

 
        <div class="tab-panels">
            
            <div id="tab-overview" class="tab-panel active" style="display: block;">
                <h2 class="section-title">ğŸ“ˆ ë§¤ì¶œ ì„±ê³¼</h2>
                <div class="kpi-grid">
                    <div class="card"><h3>ì´ ë§¤ì¶œ</h3><p id="kpi-total-sales" class="value">â‚©0</p><p id="kpi-total-sales-change" class="change-indicator"></p></div>
 
                    <div class="card"><h3>ê°ë‹¨ê°€ (AOV)</h3><p id="kpi-aov" class="value">â‚©0</p><p id="kpi-aov-change" class="change-indicator"></p></div>
                    <div class="card"><h3>ì£¼ë¬¸ ê±´ìˆ˜</h3><p id="kpi-order-count" class="value">0</p><p id="kpi-order-count-change" class="change-indicator"></p></div>
                </div>
                <h2 class="section-title" style="margin-top: 2rem;">ğŸƒ ê³ ê° í™œë™ ìƒíƒœ ìš”ì•½ (ì „ì²´ êµ¬ë§¤ ê³ ê° ê¸°ì¤€)</h2>
      
           <div class="kpi-grid">
                    <div class="card downloadable-card" onclick="downloadActivityList('Active', this)">
                        <h3>í™œì„± ê³ ê° (Active)</h3><p id="kpi-active-users" class="value status-active">0</p><p class="change-indicator"><small>(ìµœê·¼ 90ì¼ ë‚´ êµ¬ë§¤)</small></p>
                    </div>
            
         <div class="card downloadable-card" onclick="downloadActivityList('Inactive', this)">
                        <h3>ë¹„í™œì„± ê³ ê° (Inactive)</h3><p id="kpi-inactive-users" class="value status-inactive">0</p><p class="change-indicator"><small>(91ì¼ ~ 180ì¼ ë‚´ êµ¬ë§¤)</small></p>
                    </div>
                    <div class="card downloadable-card" onclick="downloadActivityList('Churn Risk', this)">
         
                <h3>ì´íƒˆ ìœ„í—˜ ê³ ê° (Churn Risk)</h3><p id="kpi-churn-users" class="value status-churn">0</p><p class="change-indicator"><small>(181ì¼ ì´ìƒ ë¯¸êµ¬ë§¤)</small></p>
                    </div>
                </div>
            </div>

            <div id="tab-customer" class="tab-panel" style="display: none;">
           
      <h2 class="section-title">ğŸ”„ ê³ ê° ìƒì• ì£¼ê¸° ë¶„ì„ (ì „ì²´ ì‚¬ìš©ì ê¸°ì¤€)</h2>
                <div class="analytics-grid single-column">
                    <div class="card chart-card">
                        <div style="display: grid;
 grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-lg);">
                            <div>
                                <h3 style="text-align: center;
 font-weight: 500; color: #555; margin-bottom: var(--spacing-md);">ê³ ê° ë¶„í¬ í˜„í™© (Count)</h3>
                                <div class="chart-container" style="position: relative;
 height: 300px; width: 100%;">
                                    <canvas id="lifecycleDistChartCanvas"></canvas>
                                </div>
                            
 </div>
                            <div>
                                <h3 style="text-align: center;
 font-weight: 500; color: #555; margin-bottom: var(--spacing-md);">ë‹¨ê³„ë³„ ë§¤ì¶œ ê¸°ì—¬ë„ (Pay GMV)</h3>
                                <div class="chart-container" style="position: relative;
 height: 300px; width: 100%;">
                                    <canvas id="lifecycleRevChartCanvas"></canvas>
                                </div>
                            
 </div>
                        </div>
                    </div>
                </div>
                <h2 class="section-title" style="margin-top: 2rem;">ğŸš€ ì‚¬ìš©ì í™•ë³´ ë¶„ì„</h2>
                <div class="kpi-grid">
 
                    <div class="card"><h3>ì´ ì‹ ê·œ ê°€ì…ì</h3><p id="kpi-new-users" class="value">0</p><p class="change-indicator"><small>ì„ íƒ ê¸°ê°„ ë‚´</small></p></div>
                    <div class="card"><h3>ì²« êµ¬ë§¤ ì „í™˜ ìˆ˜</h3><p id="kpi-new-ftps" class="value">0</p><p class="change-indicator"><small>ì‹ ê·œ ê°€ì…ì ì¤‘</small></p></div>
                    <div class="card"><h3>ì²« êµ¬ë§¤ ì „í™˜ìœ¨ (CVR)</h3><p id="kpi-new-cvr" class="value">0.0%</p><p class="change-indicator"><small>ì‹ ê·œ ê°€ì…ì ì¤‘</small></p></div>
               
  </div>
                <div class="analytics-grid">
                    <div class="card chart-card"><h3>ì›”ë³„ ì‹ ê·œ ê°€ì…ì ë° ì „í™˜ìœ¨ ì¶”ì„¸</h3>
                         <div class="chart-container" style="position: relative;
 height: 300px; width: 100%;">
                            <canvas id="acquisitionTrendChartCanvas"></canvas>
                         </div>
                    </div>
                    <div class="card chart-card"><h3>ê¸°ê°„ 
 ë‚´ ì‹ ê·œ ê°€ì…ì êµ­ê°€ ë¶„í¬</h3>
                         <div class="chart-container" style="position: relative;
 height: 300px; width: 100%;">
                            <canvas id="newUserCountryChartCanvas"></canvas>
                         </div>
                    </div>
                </div>
       
          <h2 class="section-title" style="margin-top: 2rem;">ğŸ¤µ ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ (ê¸°ê°„ ë‚´ í™œë™ ê³ ê°)</h2>
                <div class="analytics-grid single-column">
                    <div class="card">
                        <div>
                  
           <h3 class="sub-section-title">ğŸ‘‘ í•µì‹¬ ê³ ê° (VIP)</h3>
                            <div id="top_vips_table" class="table-container"></div>
                        </div>
                        <div style="margin-top: 2rem;">
      
                       <h3 class="sub-section-title">ğŸš€ ì ì¬ì  ì¶©ì„± ê³ ê°</h3>
                            <div id="top_potentials_table" class="table-container"></div>
                        </div>
                    
     <div style="margin-top: 2rem;">
                            <h3 class="sub-section-title">ğŸƒâ€â™‚ï¸ ì‹ ê·œ ê³ ê° (High-Value)</h3>
                            <div id="top_new_customers_table" class="table-container"></div>
                        </div>
        
             </div>
                </div>
            </div>

            <div id="tab-channel" class="tab-panel" style="display: none;">
                <h2 class="section-title">ğŸ“Š ì±„ë„ ë° ê²°ì œ ë¶„ì„</h2>
                <div class="analytics-grid">
      
               <div class="card chart-card"><h3><i class="fa-solid fa-mobile-screen-button"></i> í”Œë«í¼ë³„ ë§¤ì¶œ ë¹„ì¤‘</h3>
                         <div class="chart-container" style="position: relative;
 height: 300px; width: 100%;">
                            <canvas id="platformChartCanvas"></canvas>
                         </div>
                    </div>
                    <div class="card chart-card"><h3><i 
 class="fa-solid fa-credit-card"></i> ê²°ì œ ìˆ˜ë‹¨ ë¹„ì¤‘ (PGì‚¬)</h3>
                         <div class="chart-container" style="position: relative;
 height: 300px; width: 100%;">
                            <canvas id="pgChartCanvas"></canvas>
                         </div>
                    </div>
                    <div class="card chart-card"><h3><i 
 class="fa-solid fa-wallet"></i> ê²°ì œ ë°©ì‹ ë¹„ì¤‘ (Method)</h3>
                         <div class="chart-container" style="position: relative;
 height: 300px; width: 100%;">
                            <canvas id="methodChartCanvas"></canvas>
                         </div>
                    </div>
                </div>
       
          <h2 class="section-title" style="margin-top: 2rem;">ğŸ† ë§¤ì¶œ ë­í‚¹</h2>
                <div class="analytics-grid single-column">
                    <div class="card">
                        <h3>Top 10 ì‘í’ˆ</h3>
                     
    <div class="ranking-split-container">
                            <div><h4 class="ranking-sub-title">ë§¤ì¶œì•¡ ê¸°ì¤€</h4><div id="top-products-sales-table"></div></div>
                            <div><h4 class="ranking-sub-title">íŒë§¤ ìˆ˜ëŸ‰ ê¸°ì¤€</h4><div id="top-products-quantity-table"></div></div>
                        </div>
         
            </div>
                    <div class="card">
                        <h3>Top 10 ì‘ê°€</h3>
                        <div class="ranking-split-container">
                 
            <div><h4 class="ranking-sub-title">ë§¤ì¶œì•¡ ê¸°ì¤€</h4><div id="top-artists-sales-table"></div></div>
                            <div><h4 class="ranking-sub-title">ì£¼ë¬¸ ê±´ìˆ˜ ê¸°ì¤€</h4><div id="top-artists-orders-table"></div></div>
                        </div>
                    </div>
          
       </div>
            </div>

             <div id="tab-regional" class="tab-panel" style="display: none;">
                 <h2 class="section-title" id="regional-performance-title-tab">ğŸŒ ì§€ì—­ ì„±ê³¼ (ë§¤ì¶œì•¡ ê¸°ì¤€)</h2>
                 <div class="analytics-grid single-column" id="regional-performance-section-tab">
                     
                     <div class="card chart-card">
                         <div id="regional-performance-chart-container" class="chart-container" style="position: relative; height: 450px; width: 100%;">
                             <canvas id="regionalPerformanceChartCanvas"></canvas>
                         </div>
                     </div>
                     
 <div class="card" style="margin-top: 1.5rem;">
                         <h3>êµ­ê°€ë³„ ìƒì„¸ ë°ì´í„°</h3>
                         <div id="regional-performance-table-tab" class="table-container">
                             </div>
              
        </div>
                 </div>
             </div>
        </div> </div> </div> <div id="customer-detail-modal" class="modal-overlay">
  <div class="modal-content large">
    <div class="modal-header">
      <h2 class="modal-title" id="customer-modal-title">ê³ ê° ìƒì„¸ ì •ë³´</h2>
      <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
     </div>
    <div class="modal-body" id="customer-modal-body"></div>
  </div>
</div>
<div id="artist-orders-modal" class="modal-overlay">
  <div class="modal-content large">
    
 <div class="modal-header">
      <h2 class="modal-title" id="artist-modal-title">ì‘ê°€ ì£¼ë¬¸ ë‚´ì—­</h2>
      <button class="modal-close" onclick="closeArtistModal()">&times;</button>
     </div>
    <div class="modal-body" id="artist-modal-body"></div>
  </div>
</div>

<script>
  // --- Chart.js ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ ---
  let charts = {};
 // Chart.js ì¸ìŠ¤í„´ìŠ¤
  // [ìˆ˜ì •] ë¡œë”© ìŠ¤í”¼ë„ˆ HTMLì„ ì•ˆì „í•˜ê²Œ ë³€ìˆ˜ë¡œ ì €ì¥ (SyntaxError í•´ê²°)
  const loadingSpinnerHtml = <?!= JSON.stringify(include("loading")) ?>;

  // --- [ì‹ ê·œ] Datalabels Plugin ë“±ë¡ ---
  // page.txtì—ì„œ ë¡œë“œí•œ ChartDataLabels ë³€ìˆ˜ ì‚¬ìš©
  if (typeof ChartDataLabels !== 'undefined') {
      Chart.register(ChartDataLabels);
 Chart.defaults.set('plugins.datalabels', { display: false }); // ê¸°ë³¸ ë¹„í™œì„±í™”
  } else {
      console.warn("Chart.js Datalabels í”ŒëŸ¬ê·¸ì¸ì„ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
 }


  // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
  function copyToClipboard(text, element) {
      if (window.event) window.event.stopPropagation();
 if (navigator.clipboard) {
          navigator.clipboard.writeText(text).then(() => {
              const originalText = element.textContent;
              element.textContent = 'Copied!';
              element.style.color = 'var(--success-color)';
              setTimeout(() => { element.textContent = originalText; element.style.color = ''; }, 1500);
          }, (err) => 
 { console.error('Copy failed: ', err); alert('ID ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
      } else { alert('í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•Šì•„ ë³µì‚¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
 }
  }

  // --- í˜ì´ì§€ ì´ˆê¸°í™” ---
  document.addEventListener("DOMContentLoaded", function() {
    applyAnalyticsFilters(); // ë°ì´í„° ë¡œë“œ ì‹œì‘
  });
 // --- í•„í„° ì ìš© ë° ë°ì´í„° ë¡œë“œ ---
  function applyAnalyticsFilters() {
    const loader = document.getElementById('loader-container');
 const content = document.getElementById('analytics-content');
    if (loader) loader.style.display = 'block';
    if (content) content.classList.add('initially-hidden');
 // Destroy existing charts
    Object.values(charts).forEach(chart => { if (chart && typeof chart.destroy === 'function') { chart.destroy(); } });
 charts = {};
    const dateRange = document.getElementById('dateRangeFilter')?.value || '30d';
    const countryFilter = document.getElementById('countryFilter')?.value || 'all';
 // [ì‹ ê·œ] íƒ­ ë²„íŠ¼ ê°€ì‹œì„± ì œì–´
    const regionalTabButton = document.querySelector(`.tab-button[data-tab-id="tab-regional"]`);
 if (regionalTabButton) {
        regionalTabButton.style.display = (countryFilter === 'all') ? 'inline-block' : 'none';
 }

    google.script.run
      .withSuccessHandler(renderAnalytics)
      .withFailureHandler(showError)
      .getAnalyticsData(dateRange, countryFilter);
 }

  // --- [ì‹ ê·œ] í´ë¼ì´ì–¸íŠ¸ ì¸¡ ë°ì´í„° ë³€í™˜ í—¬í¼ ---
  // Helper: ë°°ì—´ì˜ ë°°ì—´ -> Chart.js ë‹¨ì¼ ë°ì´í„°ì…‹ ê°ì²´
  const formatChartData = (dataArray, labelName = 'Data') => {
      // [ìˆ˜ì •] ë°±ì—”ë“œê°€ ì´ë¯¸ Chart.js í˜•ì‹ì„ ë°˜í™˜í•œë‹¤ê³  ê°€ì • (ì´ì „ ë‹µë³€ ë‚´ìš©)
      // return dataArray;
 // <-- ì´ì „ì— ì´ ë¶€ë¶„ì„ ì œì•ˆí–ˆì—ˆìŠµë‹ˆë‹¤.
      
      // [ì¬ìˆ˜ì •] ë°±ì—”ë“œê°€ ë°°ì—´ì˜ ë°°ì—´ì„ ë°˜í™˜í•œë‹¤ê³  ê°€ì • (ì½˜ì†” ì˜¤ë¥˜ ê¸°ë°˜)
      if (!Array.isArray(dataArray) || dataArray.length < 2) {
        return { labels: [], datasets: [{ label: labelName, data: [] }] };
 }
      try {
          const headers = dataArray[0];
 const labels = dataArray.slice(1).map(row => row[0]);
          const data = dataArray.slice(1).map(row => row[1]);
 return {
            labels: labels,
            datasets: [{ label: headers[1] ||
 labelName, data: data }]
          };
 } catch (e) {
          console.error("formatChartData ì˜¤ë¥˜:", e, "ì›ë³¸ ë°ì´í„°:", dataArray);
 return { labels: [], datasets: [{ label: labelName, data: [] }] };
      }
  };
 // Helper: Acquisition Trendìš© ë‹¤ì¤‘ ë°ì´í„°ì…‹ ë³€í™˜
  const formatAcquisitionTrend = (dataArray) => {
      if (!Array.isArray(dataArray) || dataArray.length < 2) {
          return { labels: [], datasets: [] };
 }
      try {
          const headers = dataArray[0];
 const labels = dataArray.slice(1).map(row => row[0]); // Months
          const signupsData = dataArray.slice(1).map(row => row[1]);
 // Signups
          const cvrData = dataArray.slice(1).map(row => row[2]);
 // CVR
          return {
              labels: labels,
              datasets: [
                  { label: headers[1], data: signupsData, type: 'bar', yAxisID: 'ySignups' },
                  { label: headers[2], data: cvrData, type: 'line', yAxisID: 'yCvr' }
    
           ]
          };
 } catch (e) {
          console.error("formatAcquisitionTrend ì˜¤ë¥˜:", e, "ì›ë³¸ ë°ì´í„°:", dataArray);
 return { labels: [], datasets: [] };
      }
  };
 // --- [ìˆ˜ì •] ë°ì´í„° ë Œë”ë§ ---
  function renderAnalytics(data) {
    if (!data || data.error) {
        showError(data ? data.error : "ë¶„ì„ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
 hideLoaderAndShowContent(true);
        return;
    }

    try {
        // KPI ì—…ë°ì´íŠ¸ (Safe access)
        updateKpiCard('total-sales', data.kpis?.totalSales?.value, data.kpis?.totalSales?.change, 'currency');
 updateKpiCard('aov', data.kpis?.aov?.value, data.kpis?.aov?.change, 'currency');
        updateKpiCard('order-count', data.kpis?.orderCount?.value, data.kpis?.orderCount?.change, 'number');
        updateActivityKpiCard('active-users', data.activitySummary?.active);
        updateActivityKpiCard('inactive-users', data.activitySummary?.inactive);
        updateActivityKpiCard('churn-users', data.activitySummary?.churnRisk);
        updateKpiCard('new-users', data.acquisition?.kpis?.totalNewUsers, null, 'number');
 updateKpiCard('new-ftps', data.acquisition?.kpis?.totalFtps, null, 'number');
        updateKpiCard('new-cvr', data.acquisition?.kpis?.cvr, null, 'percent');

       // --- [í•µì‹¬ ìˆ˜ì •] Chart.js ë°ì´í„° ë³€í™˜ ---
        // ë°±ì—”ë“œ(code.gs)ê°€ ì´ë¯¸ Chart.js ê°ì²´ë¡œ ë³€í™˜í–ˆìœ¼ë¯€ë¡œ , í”„ë¡ íŠ¸ì—”ë“œ ë³€í™˜ ì œê±°
        const lifecycleDistributionChartJs = data.lifecycle?.distribution;
        const lifecycleRevenueChartJs = data.lifecycle?.revenue;
        const acquisitionTrendChartJs = data.acquisition?.trend;
        const newUserCountriesChartJs = data.acquisition?.countries;
        const platformChartJs = data.charts?.platformChart;
        const pgChartJs = data.charts?.pgChart;
        const methodChartJs = data.charts?.methodChart;

        // --- Chart.js ì°¨íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ ---
        drawLifecycleChart_ChartJS(lifecycleDistributionChartJs);
        drawLifecycleRevenueChart_ChartJS(lifecycleRevenueChartJs);
 drawAcquisitionTrendChart_ChartJS(acquisitionTrendChartJs);
        drawNewUserCountryChart_ChartJS(newUserCountriesChartJs);
        drawPlatformChart_ChartJS(platformChartJs);
        drawPgChart_ChartJS(pgChartJs);
        drawMethodChart_ChartJS(methodChartJs);

        // --- í…Œì´ë¸” ì±„ìš°ê¸° ---
        populateRankingTable('top-products-sales-table', ['ì‘í’ˆëª…', 'ë§¤ì¶œì•¡'], data.rankings?.topProductsBySales);
 populateRankingTable('top-products-quantity-table', ['ì‘í’ˆëª…', 'íŒë§¤ ìˆ˜ëŸ‰'], data.rankings?.topProductsByQuantity);
        populateRankingTable('top-artists-sales-table', ['ì‘ê°€ëª…', 'ë§¤ì¶œì•¡'], data.rankings?.topArtistsBySales);
        populateRankingTable('top-artists-orders-table', ['ì‘ê°€ëª…', 'ì£¼ë¬¸ ê±´ìˆ˜'], data.rankings?.topArtistsByOrders);
        populateRfmTable('top_vips_table', data.rfm?.topVips, 'vip');
        populateRfmTable('top_potentials_table', data.rfm?.topPotentials, 'potential');
 populateRfmTable('top_new_customers_table', data.rfm?.topNewCustomers, 'new');

        // --- [ìˆ˜ì •] ì§€ì—­ ì„±ê³¼ ì°¨íŠ¸ ë° í…Œì´ë¸” í˜¸ì¶œ ---
        const countryFilterVal = document.getElementById('countryFilter')?.value;
 if (countryFilterVal === 'all') {
            const regionalData = data.regionalPerformance ||
 []; // Ensure array

            // [ì‹ ê·œ] Bar Chartë¥¼ ìœ„í•œ ë°ì´í„° ë³€í™˜ (regionalDataëŠ” ê°ì²´ ë°°ì—´)
            // (ë§¤ì¶œì•¡(totalSalesInKrw) ê¸°ì¤€ Top 15, ê°€ë¡œë§‰ëŒ€ì°¨íŠ¸ë¼ reverse)
            const regionalDataSorted = [...regionalData].sort((a, b) => (b.totalSalesInKrw || 0) - (a.totalSalesInKrw || 0));
            const regionalChartData = {
                labels: regionalDataSorted.map(row => row.country || 'N/A').slice(0, 15).reverse(), 
                datasets: [{
                    label: 'ë§¤ì¶œì•¡ (KRW)',
                    data: regionalDataSorted.map(row => Math.round(row.totalSalesInKrw || 0)).slice(0, 15).reverse()
                }]
            };
            
            // [ì‹ ê·œ] ìƒˆ Bar Chart í•¨ìˆ˜ í˜¸ì¶œ
            drawRegionalPerformanceChart_ChartJS(regionalChartData);

            // ìƒì„¸ í…Œì´ë¸” (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
            populateRegionalTable('regional-performance-table-tab', regionalData);
 }

    } catch (renderError) {
        console.error("ë°ì´í„° ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", renderError);
 showError("ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + renderError.toString());
    } finally {
        hideLoaderAndShowContent();
 // [ìˆ˜ì •] ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
        const countryFilterVal = document.getElementById('countryFilter')?.value;
 const currentActiveButton = document.querySelector('.tab-button.active');
        const defaultTab = 'tab-overview';
        let tabToShow = defaultTab;
 if (currentActiveButton) {
            tabToShow = currentActiveButton.getAttribute('data-tab-id') || defaultTab;
 }
        if (tabToShow === 'tab-regional' && countryFilterVal !== 'all') {
            tabToShow = defaultTab;
 }
        showTab(tabToShow);
    }
  }

   // --- [ì‹ ê·œ] íƒ­ ì¸í„°í˜ì´ìŠ¤ í•¨ìˆ˜ ---
  function showTab(tabIdToShow) {
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
 document.querySelectorAll('.tab-panel').forEach(panel => { panel.style.display = 'none'; panel.classList.remove('active'); });

        const activeButton = document.querySelector(`.tab-button[data-tab-id="${tabIdToShow}"]`);
        if (activeButton) activeButton.classList.add('active');

        const activePanel = document.getElementById(tabIdToShow);
 if (activePanel) {
            activePanel.style.display = 'block';
 requestAnimationFrame(() => { activePanel.classList.add('active'); });
        }

        // ì§€ì—­ ì„±ê³¼ íƒ­ ë²„íŠ¼ ê°€ì‹œì„± ì œì–´
        const regionalTabButton = document.querySelector(`.tab-button[data-tab-id="tab-regional"]`);
 if (regionalTabButton) {
            const countryFilterVal = document.getElementById('countryFilter')?.value;
 regionalTabButton.style.display = (countryFilterVal === 'all') ? 'inline-block' : 'none';
        }
  }

  // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
  function updateKpiCard(id, value, change, format) {
      const valueEl = document.getElementById(`kpi-${id}`);
 const changeEl = document.getElementById(`kpi-${id}-change`);
      const displayValue = (value !== null && value !== undefined) ?
 value : (format === 'currency' || format === 'number' ? 0 : '0.0%');
 const displayChange = (change !== null && change !== undefined && isFinite(change)) ? change : null;
 if (valueEl) {
          if (format === 'currency') valueEl.textContent = `â‚©${Math.round(displayValue).toLocaleString()}`;
 else if (format === 'percent') valueEl.textContent = `${(displayValue * 100).toFixed(1)}%`;
          else valueEl.textContent = displayValue.toLocaleString();
 }
      if (changeEl) {
           if (displayChange !== null) {
               if (displayChange === Infinity) { changeEl.innerHTML = `<span class="up">â–²</span> New`;
 changeEl.className = 'change-indicator up'; }
               else if (displayChange >= 0) { changeEl.innerHTML = `<span class="up">â–²</span> ${(displayChange * 100).toFixed(1)}% <small>(vs prev)</small>`;
 changeEl.className = 'change-indicator up'; }
               else { changeEl.innerHTML = `<span class="down">â–¼</span> ${(Math.abs(displayChange) * 100).toFixed(1)}% <small>(vs prev)</small>`;
 changeEl.className = 'change-indicator down'; }
           } else { changeEl.innerHTML = '';
 changeEl.className = 'change-indicator'; }
      }
  }
  function updateActivityKpiCard(id, value) {
      const valueEl = document.getElementById(`kpi-${id}`);
 const displayValue = (value !== null && value !== undefined) ? value : 0;
      if (valueEl) { valueEl.textContent = displayValue.toLocaleString();
 }
  }

  // --- í…Œì´ë¸” ìƒì„± í•¨ìˆ˜ ---
  function populateRankingTable(elementId, headers, data) {
      const container = document.getElementById(elementId);
 if (!container) { console.error("Container not found:", elementId); return; }
      const tableData = Array.isArray(data) ?
 data : [];
      if (tableData.length === 0) { container.innerHTML = '<div class="table-container no-data"><p class="no-data-message">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>'; return;
 }
      let tableHtml = '<div class="table-container"><table class="table ranking-table"><thead><tr><th style="width: 50px;">ìˆœìœ„</th>';
 headers.forEach((header) => { tableHtml += `<th>${header}</th>`; });
      tableHtml += '</tr></thead><tbody>';
      const isQuantityTable = headers.includes('íŒë§¤ ìˆ˜ëŸ‰'); const isOrdersTable = headers.includes('ì£¼ë¬¸ ê±´ìˆ˜');
 const isProductTable = elementId.includes('products'); const isArtistTable = elementId.includes('artists');
      tableData.forEach((row, index) => {
          if (!Array.isArray(row) || row.length < 2) return;
          const name = row[0] || 'N/A'; const value = row[1]; let nameHtml = name; let valueFormatted = '-';
          if (value !== null && value !== undefined) {
            if (isQuantityTable) valueFormatted = `${parseInt(value).toLocaleString()} <small>ê°œ</small>`;
           
  else if (isOrdersTable) valueFormatted = `${parseInt(value).toLocaleString()} <small>ê±´</small>`;
            else valueFormatted = `â‚©${Math.round(value).toLocaleString()}`;
          }
          if (isProductTable && row.length > 2 && row[2] && row[2] !== '#') { const url = row[2]; nameHtml = `<a href="${url}" target="_blank" class="item-link" title="${name} ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™">${name}</a>`; }
          else if (isArtistTable) { const safeName = String(name).replace(/'/g, "\\'"); nameHtml = `<span class="artist-name-link" onclick="openArtistModal('${safeName}')" title="'${name}' ì‘ê°€ì˜ ì£¼ë¬¸ ë‚´ì—­ ë³´ê¸°">${name}</span>`; }
  
         tableHtml += `<tr><td style="text-align: center;">${index + 1}</td><td class="ranking-name-cell" title="${name}">${nameHtml}</td><td style="text-align: right;">${valueFormatted}</td></tr>`;
      });
 tableHtml += '</tbody></table></div>'; container.innerHTML = tableHtml;
  }
  function populateRegionalTable(elementId, data) {
      const container = document.getElementById(elementId);
 if (!container) { console.error("Container not found:", elementId); return; }
      const tableData = Array.isArray(data) ?
 data : [];
      if (tableData.length === 0) { container.innerHTML = '<div class="table-container no-data"><p class="no-data-message">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>'; return;
 }
      const headers = ['êµ­ê°€', 'ì´ ë§¤ì¶œ (USD)', 'ì´ ë§¤ì¶œ (KRW)', 'ë§¤ì¶œ ë¹„ì¤‘', 'ì£¼ë¬¸ ê±´ìˆ˜', 'ê°ë‹¨ê°€ (KRW)'];
 let tableHtml = '<div class="table-container"><table class="table"><thead><tr>';
      headers.forEach(header => tableHtml += `<th>${header}</th>`); tableHtml += '</tr></thead><tbody>';
 tableData.forEach(row => { tableHtml += `<tr><td>${row.country||'N/A'}</td><td class="col-numeric">$${Math.round(row.totalOriginalSales||0).toLocaleString()}</td><td class="col-numeric">â‚©${Math.round(row.totalSalesInKrw||0).toLocaleString()}</td><td class="col-numeric">${((row.salesShare||0)*100).toFixed(1)}%</td><td class="col-numeric">${(row.orderCount||0).toLocaleString()}</td><td class="col-numeric">â‚©${Math.round(row.aovInKrw||0).toLocaleString()}</td></tr>`; });
      tableHtml += '</tbody></table></div>'; container.innerHTML = tableHtml;
 }
  function populateRfmTable(elementId, data, segmentType) {
      const container = document.getElementById(elementId);
 if (!container) { console.error('Container element not found:', elementId); return; }
      const tableData = Array.isArray(data) ?
 data : [];
      if (tableData.length === 0) { container.innerHTML = '<div class="table-container no-data"><p class="no-data-message">í•´ë‹¹ ê³ ê° ì—†ìŒ</p></div>'; return;
 }
      let headers = []; let tableHtml = '<div class="table-container"><table class="table crm-table"><thead><tr>';
 const commonHeaders = [ { label: 'User ID', class: 'col-user-id' }, { label: 'ê³ ê°ëª…', class: 'col-name' }, { label: 'êµ­ê°€', class: 'col-country' }, { label: 'í™œë™ ìƒíƒœ', class: 'col-status' } ];
 if (segmentType === 'vip') { headers = [...commonHeaders, { label: 'í‰ìƒ êµ¬ë§¤ì•¡(M)', class: 'col-numeric col-monetary' }, { label: 'ì£¼ë¬¸ìˆ˜(F)', class: 'col-numeric col-frequency' }, { label: 'ìµœê·¼ ì£¼ë¬¸ì¼(R)', class: 'col-recency' }];
 }
      else if (segmentType === 'potential') { headers = [...commonHeaders, { label: 'ì‘ê°€ ë‹¤ì–‘ì„±', class: 'col-numeric col-artist-diversity' }, { label: 'í‰ìƒ êµ¬ë§¤ì•¡(M)', class: 'col-numeric col-monetary' }, { label: 'ì£¼ë¬¸ìˆ˜(F)', class: 'col-numeric col-frequency' }];
 }
      else if (segmentType === 'new') { headers = [...commonHeaders, { label: 'ì²« ì£¼ë¬¸ ê¸ˆì•¡', class: 'col-numeric col-first-amount' }, { label: 'ì²« ì£¼ë¬¸ ì‘í’ˆìˆ˜', class: 'col-numeric col-first-count' }, { label: 'ì²« ì£¼ë¬¸ì¼', class: 'col-first-date' }];
 }
      else { headers = commonHeaders;
 }
      headers.forEach(header => { tableHtml += `<th class="${header.class || ''}">${header.label}</th>`; }); tableHtml += '</tr></thead><tbody>';
 const statusClassMap = { 'Active': 'status-active', 'Inactive': 'status-inactive', 'Churn Risk': 'status-churn', 'N/A': '' };
 tableData.forEach(row => {
          const status = row.activityStatus || 'N/A'; const statusClass = statusClassMap[status] || '';
          const userId = row.userId || 'N/A'; const name = row.name || 'N/A'; const country = row.country || 'N/A';
          const M = row.M !== undefined ? Math.round(row.M).toLocaleString() : '-'; const F = row.F !== undefined ? `${row.F}íšŒ` : '-';
          const R = row.R !== undefined && row.R !== Infinity ? 
 `${row.R}ì¼ ì „` : '-'; const lastOrderDate = row.lastOrderDate || 'N/A';
          const artistCount = row.artistCount !== undefined ? `${row.artistCount}ëª…` : '-'; const firstAmount = row.firstOrderAmount !== undefined ? `â‚©${Math.round(row.firstOrderAmount).toLocaleString()}` : '-';
          const firstCount = row.firstOrderProductCount !== undefined ? `${row.firstOrderProductCount}ê°œ` : '-'; const firstDate = row.firstOrderDate || 'N/A';
          let rowsHtml = `<tr><td class="col-user-id" title="${userId}"><a class="user-id-link" href="javascript:void(0)" onclick="openCustomerModal('${userId}')">${userId}</a><span class="copy-icon" title="ID ë³µì‚¬" onclick="copyToClipboard('${userId}', this)">ğŸ“‹</span></td><td class="col-name" title="${name}">${name}</td><td class="col-country">${country}</td><td class="col-status ${statusClass}">${status}</td>`;
 if (segmentType === 'vip') { rowsHtml += `<td class="col-numeric col-monetary">â‚©${M}</td><td class="col-numeric col-frequency">${F}</td><td class="col-recency">${lastOrderDate}<br><small>(${R})</small></td>`;
 }
          else if (segmentType === 'potential') { rowsHtml += `<td class="col-numeric col-artist-diversity">${artistCount}</td><td class="col-numeric col-monetary">â‚©${M}</td><td class="col-numeric col-frequency">${F}</td>`;
 }
          else if (segmentType === 'new') { rowsHtml += `<td class="col-numeric col-first-amount">${firstAmount}</td><td class="col-numeric col-first-count">${firstCount}</td><td class="col-first-date">${firstDate}</td>`;
 }
          rowsHtml += `</tr>`; tableHtml += rowsHtml;
      });
      tableHtml += '</tbody></table></div>';
 container.innerHTML = tableHtml;
  }

  // --- ìˆ«ì í¬ë§· í—¬í¼ ---
  function formatShortNumber(value) { if (value === null || value === undefined) return '-';
 if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B'; if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
 if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K'; return value < 1000 ? value.toFixed(0) : value.toLocaleString(undefined, {maximumFractionDigits: 0});
 }
  function formatNumber(value) { return (value === null || value === undefined) ?
 '-' : value.toLocaleString();}
  function formatCurrency(value) { return (value === null || value === undefined) ?
 '-' : 'â‚©' + Math.round(value).toLocaleString();}

  // --- Chart.js ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤ ---
  const chartJsDefaultOptions = { 
      responsive: true, 
      maintainAspectRatio: false, 
      animation: { duration: 600, easing: 'easeOutQuart' }, 
      plugins: { 
          legend: { 
              position: 'bottom', 
              labels: { font: { family: 'Pretendard', size: 11 }, color: '#555', padding: 15 } 
          }, 
          // [ìˆ˜ì •] íˆ´íŒ ê¸°ë³¸ê°’ì„ ë¹„í™œì„±í™”ëœ ì»¤ìŠ¤í…€ íˆ´íŒìœ¼ë¡œ ë³€ê²½
          tooltip: { 
              enabled: false, 
              external: customTooltip,
              mode: 'index', 
              intersect: false, 
              // íˆ´íŒ ìŠ¤íƒ€ì¼ì€ chart_styles.txtì˜ #chartjs-tooltipì—ì„œ ê´€ë¦¬
          } 
      }, 
      scales: { 
          x: { 
              grid: { display: false }, 
              ticks: { 
           font: { family: 'Pretendard', size: 11 }, color: '#555' } 
          }, 
          y: { 
              grid: { color: '#eee' }, 
              ticks: { font: { family: 'Pretendard', size: 11 }, color: '#555' }, 
              beginAtZero: true 
          } 
      }, 
      layout: { padding: { top: 10, right: 20, bottom: 0, left: 10 } } 
  };
 function isChartDataValid(chartData) { return chartData && chartData.labels && Array.isArray(chartData.labels) && chartData.labels.length > 0 && chartData.datasets && Array.isArray(chartData.datasets) && chartData.datasets.length > 0 && chartData.datasets[0].data && Array.isArray(chartData.datasets[0].data) && chartData.datasets[0].data.length > 0;
 }

  // [ê°œì„ ] Datalabels ì ìš©
  function drawLifecycleChart_ChartJS(chartData) {
      const canvasId = 'lifecycleDistChartCanvas';
 const ctx = document.getElementById(canvasId); if (!ctx) { return; } const container = ctx.closest('.chart-container');
 if (!isChartDataValid(chartData)) { if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>'; if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; } return;
 }
      if (charts[canvasId]) charts[canvasId].destroy();
      const stageColors = { Prospect: '#BDBDBD', New: '#64B5F6', Growing: '#29B6F6', Core: '#0288D1', Dormant: '#FFA726', Churned: '#EF5350' };
 const backgroundColors = chartData.labels.map(label => stageColors[label] || '#9E9E9E');
      charts[canvasId] = new Chart(ctx, {
          type: 'bar',
          data: { labels: chartData.labels, datasets: [{ ...chartData.datasets[0], backgroundColor: backgroundColors }] },
          options: {
              ...chartJsDefaultOptions, indexAxis: 'y',
              scales: { x: { ...chartJsDefaultOptions.scales.x, title: { display: true, text: 'ê³ ê° ìˆ˜' }, ticks: { callback: 
 v => formatNumber(v) } }, y: { ...chartJsDefaultOptions.scales.y, grid: { display: false } } },
              plugins: {
                  legend: { display: false },
                  tooltip: { // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
                      enabled: false,
                      external: customTooltip
                  },
                  datalabels: { display: true, color: '#fff', anchor: 'center', align: 'center', font: { 
 weight: 'bold', size: 10 }, formatter: (value) => value > 0 ? value.toLocaleString() : '' }
              }, layout: { padding: { left: 20, right: 30, top: 10, bottom: 10 } }
          }
      });
 }
  function drawLifecycleRevenueChart_ChartJS(chartData) {
       const canvasId = 'lifecycleRevChartCanvas'; const ctx = document.getElementById(canvasId);
 if (!ctx) return; const container = ctx.closest('.chart-container');
       if (!isChartDataValid(chartData)) { if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>';
 if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; } return; }
       if (charts[canvasId]) charts[canvasId].destroy();
 const stageColors = { Prospect: '#BDBDBD', New: '#64B5F6', Growing: '#29B6F6', Core: '#0288D1', Dormant: '#FFA726', Churned: '#EF5350' };
 const backgroundColors = chartData.labels.map(label => stageColors[label] || '#9E9E9E');
       charts[canvasId] = new Chart(ctx, {
           type: 'bar', data: { labels: chartData.labels, datasets: [{ ...chartData.datasets[0], backgroundColor: backgroundColors }] },
           options: { ...chartJsDefaultOptions, indexAxis: 'y', scales: { x: { ...chartJsDefaultOptions.scales.x, title: { display: true, text: 'ë§¤ì¶œì•¡ (KRW)' }, ticks: { callback: value => formatShortNumber(value) } }, y: { ...chartJsDefaultOptions.scales.y, grid: { display: false } } },
               plugins: { legend: { 
 display: false }, 
                   tooltip: { // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
                       enabled: false,
                       external: customTooltip,
                       callbacks: { // [ì¤‘ìš”] ê¸°ì¡´ ì½œë°± ìœ ì§€
                           label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` 
                       }
                   },
                   datalabels: { display: true, color: '#fff', anchor: 'center', align: 'center', font: { weight: 'bold', size: 9 }, formatter: (value) => value > 1000 ? formatShortNumber(value) : '' }
               }, layout: { padding: { left: 20, right: 30, top: 10, bottom: 10 } }
           
 }
       });
  }
  function drawAcquisitionTrendChart_ChartJS(chartData) {
      const canvasId = 'acquisitionTrendChartCanvas';
 const ctx = document.getElementById(canvasId); if (!ctx) return; const container = ctx.closest('.chart-container');
 if (!isChartDataValid(chartData) || !chartData.datasets || chartData.datasets.length < 2) { if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>'; if (charts[canvasId]) { charts[canvasId].destroy();
 delete charts[canvasId]; } return; }
      if (charts[canvasId]) charts[canvasId].destroy();
 charts[canvasId] = new Chart(ctx, {
          data: { labels: chartData.labels, datasets: [ { ...chartData.datasets[0], backgroundColor: '#a1c4fd', borderColor: '#a1c4fd', order: 1 }, { ...chartData.datasets[1], borderColor: '#4A6FA5', tension: 0.1, order: 0, pointRadius: 3 } ] },
          options: { ...chartJsDefaultOptions,
              plugins: {
                  legend: chartJsDefaultOptions.plugins.legend,
             
      tooltip: { // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
                       enabled: false,
                       external: customTooltip,
                       callbacks: { // [ì¤‘ìš”] ê¸°ì¡´ ì½œë°± ìœ ì§€
                           label: function(context) { let l = context.dataset.label||''; if(l)l+=': '; let v=context.raw; if(context.datasetIndex===1){l+=(v*100).toFixed(1)+'%'}else{l+=formatNumber(v)} return l; } 
                       }
                   },
                  datalabels: { display: false }
              },
              scales: { x: { ...chartJsDefaultOptions.scales.x, grid: { display: false }, ticks: { autoSkipPadding: 15 } }, ySignups: { type: 'linear', position: 'left', grid: { 
 color: '#eee' }, ticks: { font: { family: 'Pretendard', size: 11 }, color: '#555', callback: v => formatNumber(v) }, title: { display: true, text: 'ì‹ ê·œ ê°€ì…ì ìˆ˜', font: { family: 'Pretendard', size: 12 }, color: '#333' } }, yCvr: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { font: { family: 'Pretendard', size: 11 }, color: '#4A6FA5', callback: v => (v * 100).toFixed(0) + '%' }, title: { display: true, text: 'ì²« êµ¬ë§¤ ì „í™˜ìœ¨', font: { family: 'Pretendard', size: 12 }, color: '#333' } } },
            
   interaction: { mode: 'index', intersect: false }
          }
      });
 }
  function drawNewUserCountryChart_ChartJS(chartData) {
      const canvasId = 'newUserCountryChartCanvas'; const ctx = document.getElementById(canvasId);
 if (!ctx) return; const container = ctx.closest('.chart-container');
      if (!isChartDataValid(chartData)) { if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>';
 if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; } return; }
      if (charts[canvasId]) charts[canvasId].destroy();
 charts[canvasId] = new Chart(ctx, {
          type: 'bar', data: { labels: chartData.labels, datasets: [{ ...chartData.datasets[0], backgroundColor: '#6D9886' }] },
          options: { ...chartJsDefaultOptions, indexAxis: 'y',
              scales: { x: { ...chartJsDefaultOptions.scales.x, title: { display: true, text: 'ê°€ì…ì ìˆ˜' }, ticks: { callback: v => formatNumber(v) } }, y: { ...chartJsDefaultOptions.scales.y, grid: { display: false }, ticks: { font: { size: 10 } } } },
        
       plugins: {
                  legend: { display: false }, 
                  tooltip: { // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
                      enabled: false,
                      external: customTooltip
                  },
                  datalabels: { display: true, color: '#fff', anchor: 'center', align: 'center', font: { weight: 'bold', size: 9 }, formatter: (value) => value > 0 ? value.toLocaleString() : '' }
              }, layout: { padding: { left: 20, right: 30, top: 
 10, bottom: 10 } }
          }
      });
 }
  function drawPlatformChart_ChartJS(chartData) {
      const canvasId = 'platformChartCanvas'; const ctx = document.getElementById(canvasId);
 if (!ctx) return; const container = ctx.closest('.chart-container');
      if (!isChartDataValid(chartData)) { if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>';
 if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; } return; }
      if (charts[canvasId]) charts[canvasId].destroy();
 charts[canvasId] = new Chart(ctx, {
          type: 'bar', data: { labels: chartData.labels, datasets: [{ ...chartData.datasets[0], backgroundColor: '#4A6FA5' }] },
          options: { ...chartJsDefaultOptions, indexAxis: 'y',
              scales: { x: { ...chartJsDefaultOptions.scales.x, title: { display: true, text: 'ë§¤ì¶œì•¡ (KRW)' }, ticks: { callback: v => formatShortNumber(v) } }, y: { ...chartJsDefaultOptions.scales.y, grid: { display: false } } },
              plugins: {
 
                  legend: { display: false }, 
                  tooltip: { // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
                      enabled: false,
                      external: customTooltip,
                      callbacks: { // [ì¤‘ìš”] ê¸°ì¡´ ì½œë°± ìœ ì§€
                          label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` 
                      }
                  },
                  datalabels: { display: true, color: '#fff', anchor: 'center', align: 'center', font: { weight: 'bold', size: 9 }, formatter: (value) => value > 1000 ? formatShortNumber(value) : '' }
              }, layout: { padding: { left: 20, right: 
 30, top: 10, bottom: 10 } }
          }
      });
 }
  function drawPgChart_ChartJS(chartData) {
       const canvasId = 'pgChartCanvas'; const ctx = document.getElementById(canvasId);
 if (!ctx) return; const container = ctx.closest('.chart-container');
       if (!isChartDataValid(chartData)) { if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>';
 if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; } return; }
       if (charts[canvasId]) charts[canvasId].destroy();
 charts[canvasId] = new Chart(ctx, {
           type: 'bar', data: { labels: chartData.labels, datasets: [{ ...chartData.datasets[0], backgroundColor: '#577590' }] },
           options: { ...chartJsDefaultOptions, indexAxis: 'y',
               scales: { x: { ...chartJsDefaultOptions.scales.x, title: { display: true, text: 'ì£¼ë¬¸ ê±´ìˆ˜' }, ticks: { callback: v => formatNumber(v) } }, y: { ...chartJsDefaultOptions.scales.y, grid: { display: false } } },
             
   plugins: {
                   legend: { display: false }, 
                   tooltip: { // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
                      enabled: false,
                      external: customTooltip
                   },
                   datalabels: { display: true, color: '#fff', anchor: 'center', align: 'center', font: { weight: 'bold', size: 9 }, formatter: (value) => value > 0 ? value.toLocaleString() : '' }
               }, layout: { padding: { left: 20, right: 30, top: 10, 
 bottom: 10 } }
           }
       });
 }
  function drawMethodChart_ChartJS(chartData) {
       const canvasId = 'methodChartCanvas'; const ctx = document.getElementById(canvasId);
 if (!ctx) return; const container = ctx.closest('.chart-container');
       if (!isChartDataValid(chartData)) { if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>';
 if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; } return; }
       if (charts[canvasId]) charts[canvasId].destroy();
 charts[canvasId] = new Chart(ctx, {
           type: 'bar', data: { labels: chartData.labels, datasets: [{ ...chartData.datasets[0], backgroundColor: '#6D9886' }] },
           options: { ...chartJsDefaultOptions, indexAxis: 'y',
               scales: { x: { ...chartJsDefaultOptions.scales.x, title: { display: true, text: 'ì£¼ë¬¸ ê±´ìˆ˜' }, ticks: { callback: v => formatNumber(v) } }, y: { ...chartJsDefaultOptions.scales.y, grid: { display: false } } },
             
   plugins: {
                   legend: { display: false }, 
                   tooltip: { // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
                      enabled: false,
                      external: customTooltip
                   },
                   datalabels: { display: true, color: '#fff', anchor: 'center', align: 'center', font: { weight: 'bold', size: 9 }, formatter: (value) => value > 0 ? value.toLocaleString() : '' }
               }, layout: { padding: { left: 20, right: 30, top: 10, 
 bottom: 10 } }
           }
       });
 }
  
  function drawRegionalPerformanceChart_ChartJS(chartData) {
      const canvasId = 'regionalPerformanceChartCanvas';
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      const container = ctx.closest('.chart-container');
      
      if (!isChartDataValid(chartData)) {
          if (container) container.innerHTML = '<p class="no-data-message">ë°ì´í„° ì—†ìŒ</p>';
          if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; }
          return;
      }
      if (charts[canvasId]) charts[canvasId].destroy();

      charts[canvasId] = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: chartData.labels,
              datasets: [{
                  ...chartData.datasets[0],
                  label: 'ë§¤ì¶œì•¡ (KRW)',
                  backgroundColor: '#4A6FA5' // Primary color
              }]
          },
          options: {
              ...chartJsDefaultOptions,
              indexAxis: 'y', // ê°€ë¡œ ë§‰ëŒ€ ì°¨íŠ¸
              scales: {
                  x: {
                      ...chartJsDefaultOptions.scales.x,
                      title: { display: true, text: 'ë§¤ì¶œì•¡ (KRW)' },
                      ticks: { callback: v => formatShortNumber(v) } // ì¶•ì•½ ìˆ«ì
                  },
                  y: {
                      ...chartJsDefaultOptions.scales.y,
                      grid: { display: false },
                      ticks: { font: { size: 10 } }
                  }
              },
              plugins: {
                  legend: { display: false },
                  tooltip: { // [ì¤‘ìš”] ì»¤ìŠ¤í…€ íˆ´íŒ ì ìš©
                      enabled: false,
                      external: customTooltip,
                      callbacks: { // formatCurrency ì½œë°± ì§€ì •
                           label: function(context) {
                               return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                           }
                      }
                  },
                  datalabels: { // Datalabels í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
                      display: true,
                      color: '#fff',
                      anchor: 'center',
                      align: 'center',
                      font: { weight: 'bold', size: 9 },
                      formatter: (value) => value > 1000 ? formatShortNumber(value) : ''
                  }
              },
              layout: { padding: { left: 20, right: 30, top: 10, bottom: 10 } }
          }
      });
  }

  function customTooltip(context) {
        // íˆ´íŒ ì—˜ë¦¬ë¨¼íŠ¸ ê°€ì ¸ì˜¤ê¸°
        let tooltipEl = document.getElementById('chartjs-tooltip');

        // ì—†ìœ¼ë©´ ìƒì„±
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = 'chartjs-tooltip';
            document.body.appendChild(tooltipEl);
        }

        const tooltipModel = context.tooltip;
        // íˆ´íŒ ìˆ¨ê¸°ê¸°
        if (tooltipModel.opacity === 0) {
            tooltipEl.style.opacity = 0;
            return;
        }

        // íˆ´íŒ ë‚´ìš© ì„¤ì •
        let innerHtml = '';

        // ì œëª© (Title)
        if (tooltipModel.title && tooltipModel.title.length > 0) {
            const title = tooltipModel.title[0];
            // 'time' ìŠ¤ì¼€ì¼ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° (ì˜ˆ: acquisitionTrendChart)
            if (context.chart.options.scales.x.type === 'time') {
                 innerHtml += '<strong>' + moment(title).format('YYYY-MM-DD (ddd)') + '</strong><br>';
            } else {
                 innerHtml += '<strong>' + title + '</strong><br>';
            }
            innerHtml += '<hr>'; //
        }

        // ë³¸ë¬¸ (Body)
        if (tooltipModel.body) {
            const bodyLines = tooltipModel.body.map(b => b.lines);
            bodyLines.forEach((body, i) => {
                const dataPoint = tooltipModel.dataPoints[i];
                const colors = tooltipModel.labelColors[i];
                
                // íˆ´íŒ ì½œë°±ì´ ìˆëŠ”ì§€ í™•ì¸ (label)
                const labelCallback = context.chart.options.plugins.tooltip.callbacks.label;
                let labelText = '';
                
                if (labelCallback) {
                    // ê°œë³„ ì°¨íŠ¸ì— ì •ì˜ëœ ì½œë°± ì‹¤í–‰ (ì˜ˆ: formatCurrency, CVR í¬ë§·íŒ… ë“±)
                    labelText = labelCallback(dataPoint);
                } else {
                    // ì½œë°±ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë™ì‘
                    let label = dataPoint.dataset.label || '';
                    if (label) { label += ': '; }
                    if (dataPoint.formattedValue !== null) {
                        label += dataPoint.formattedValue;
                    }
                    labelText = label;
                }
                
                // ì»¬ëŸ¬ ìŠ¤í€˜ì–´
                let style = 'background:' + colors.backgroundColor;
                style += '; border-color:' + colors.borderColor;
                style += '; border-width: 2px; display: inline-block; width: 10px; height: 10px; margin-right: 6px; vertical-align: middle;';
                const span = '<span style="' + style + '"></span> ';
                
                innerHtml += '<div>' + span + labelText + '</div>';
            });
        }

        tooltipEl.innerHTML = innerHtml || '(ë°ì´í„° ì—†ìŒ)'; // ë‚´ìš©ì´ ì—†ì„ ê²½ìš° ëŒ€ë¹„

        // íˆ´íŒ ìœ„ì¹˜ ê³„ì‚°
        const position = context.chart.canvas.getBoundingClientRect();
        tooltipEl.style.opacity = 1;
        
        let left = position.left + window.pageXOffset + tooltipModel.caretX;
        let top = position.top + window.pageYOffset + tooltipModel.caretY;

        // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì¡°ì •
         if (left + tooltipEl.offsetWidth > window.innerWidth - 10) {
           left = window.innerWidth - tooltipEl.offsetWidth - 10;
         }
         if (left < 10) {
           left = 10;
         }
        if (tooltipModel.yAlign === 'above' || top + tooltipEl.offsetHeight > window.innerHeight - 10) {
          top -= tooltipEl.offsetHeight + 10; // ì»¤ì„œ ìœ„ë¡œ
        } else {
          top += 10; // ì»¤ì„œ ì•„ë˜ë¡œ
        }
         if (top < 10) {
           top = 10;
         }

        tooltipEl.style.left = left + 'px';
        tooltipEl.style.top = top + 'px';
    }

  // --- ëª¨ë‹¬ í•¨ìˆ˜ ---
  function openCustomerModal(userId) {
      if (window.event) window.event.stopPropagation();
 const m = document.getElementById('customer-detail-modal'); const b = document.getElementById('customer-modal-body'); const t = document.getElementById('customer-modal-title');
      if(!m || !b || !t) return;
 t.textContent = `ê³ ê° ìƒì„¸ ì •ë³´ (ID: ${userId})`;
      b.innerHTML = loadingSpinnerHtml; // [ìˆ˜ì •] SyntaxError í•´ê²°
      m.style.display = 'flex';
      google.script.run.withSuccessHandler(populateCustomerModal).withFailureHandler(showCustomerModalError).getCustomerDetail(userId);
 }
  function populateCustomerModal(data){
      const b = document.getElementById('customer-modal-body'); if(!b) return;
 if (data === null || data === undefined) { showCustomerModalError("ì„œë²„ë¡œë¶€í„° ê³ ê° ìƒì„¸ ì •ë³´ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (null ë°˜í™˜)"); return;
 }
      if (data.error) { showCustomerModalError(data.error); return;
 }
      const p = data.profile ||
 { name: 'N/A', email: 'N/A', country: 'N/A', createdAt: 'N/A' };
 const pHtml = `<div class="modal-section" style="background-color:var(--hover-color);padding:16px;border-radius:8px;margin-bottom:24px"><h4 style="margin-top:0">ê³ ê° í”„ë¡œí•„</h4><p><strong>ê³ ê°ëª…:</strong> ${p.name||'N/A'}</p><p><strong>ì´ë©”ì¼:</strong> ${p.email||'N/A'}</p><p><strong>êµ­ê°€:</strong> ${p.country||'N/A'}</p><p><strong>ê°€ì…ì¼:</strong> ${p.createdAt||'N/A'}</p></div>`;
      const stats = data.stats ||
 { R: 'N/A', F: 0, M: 0, ArtistDiversity: 0 };
      const rDisplay = stats.R !== 'N/A' ?
 `${stats.R}<small>ì¼ ì „</small>` : 'N/A'; const fDisplay = `${stats.F}<small>íšŒ</small>`; const mDisplay = `â‚©${Math.round(stats.M).toLocaleString()}`; const aDisplay = `${stats.ArtistDiversity}<small>ëª…</small>`;
 const rfmHtml = `<div class="kpi-grid" style="margin-bottom:24px;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem"><div class="card" style="padding:16px;text-align:center"><h3 style="font-size:13px">ìµœê·¼ êµ¬ë§¤ì¼ (R)</h3><p class="value" style="font-size:24px">${rDisplay}</p></div><div class="card" style="padding:16px;text-align:center"><h3 style="font-size:13px">êµ¬ë§¤ ë¹ˆë„ (F)</h3><p class="value" style="font-size:24px">${fDisplay}</p></div><div class="card" style="padding:16px;text-align:center"><h3 style="font-size:13px">ì´ êµ¬ë§¤ì•¡ (M)</h3><p class="value" style="font-size:24px">${mDisplay}</p></div><div class="card" style="padding:16px;text-align:center"><h3 style="font-size:13px">ì‘ê°€ ë‹¤ì–‘ì„±</h3><p class="value" style="font-size:24px">${aDisplay}</p></div></div>`;
 const orders = Array.isArray(data.orders) ? data.orders : []; const artists = Array.isArray(data.artistList) ? data.artistList : [];
 const oHtml = orders.length > 0 ? orders.map(o => `<li>${o.dateFormatted || 'N/A'}: ${o.orderCode || 'N/A'} (ì‘í’ˆ ${o.productCount || 0}ê°œ, â‚©${Math.round(o.amount || 0).toLocaleString()})</li>`).join('') : '<li>ì£¼ë¬¸ ë‚´ì—­ ì—†ìŒ</li>';
 const aHtml = artists.length > 0 ? artists.map(a => `<li>${a}</li>`).join('') : '<li>êµ¬ë§¤ ì‘ê°€ ì—†ìŒ</li>';
 const gHtml = `<div class="modal-grid"><div class="modal-section"><h4>ì£¼ë¬¸ ë‚´ì—­ (ìµœê·¼ìˆœ)</h4><div class="item-list-container" style="max-height:200px;"><ul class="item-list">${oHtml}</ul></div></div><div class="modal-section"><h4>êµ¬ë§¤ ì‘ê°€ ëª©ë¡ (Unique)</h4><div class="item-list-container" style="max-height:200px;"><ul class="item-list">${aHtml}</ul></div></div></div>`;
 b.innerHTML = pHtml + rfmHtml + gHtml;
  }
  function showCustomerModalError(error){ const b = document.getElementById('customer-modal-body');
 if(b) b.innerHTML = `<p class="error-message">ì˜¤ë¥˜: ${error.toString()}</p>`; }
  function closeCustomerModal(){ const m = document.getElementById('customer-detail-modal'); if(m) m.style.display = 'none';
 }
  function openArtistModal(artistName){
      if (window.event) window.event.stopPropagation();
      const m=document.getElementById('artist-orders-modal'),b=document.getElementById('artist-modal-body'),t=document.getElementById('artist-modal-title');if(!m||!b||!t)return;
 const d=document.getElementById('dateRangeFilter').value;t.textContent=`'${artistName}' ì‘ê°€ ì£¼ë¬¸ ë‚´ì—­ (${d} ê¸°ì¤€)`;
      b.innerHTML=loadingSpinnerHtml; // [ìˆ˜ì •] SyntaxError í•´ê²°
      m.style.display='flex';
      google.script.run.withSuccessHandler(populateArtistModal).withFailureHandler(showArtistModalError).getOrdersByArtist(artistName,d);
 }
  function populateArtistModal(data){
      const b=document.getElementById('artist-modal-body');if(!b)return;if(data.error){showArtistModalError(data.error);return}
      if(!data.orders||data.orders.length===0){b.innerHTML='<p class="no-data-message">í•´ë‹¹ ê¸°ê°„ ë™ì•ˆ ì´ ì‘ê°€ì˜ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';return}
      let h=`<div class="table-container" style="max-height:400px;overflow-y:auto"><table class="table ranking-table"><thead><tr><th>ì£¼ë¬¸ì¼</th><th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ì‘í’ˆëª…</th><th>ìˆ˜ëŸ‰</th><th>íŒë§¤ì•¡ (KRW)</th></tr></thead><tbody>`;
 data.orders.forEach(o=>{o.items.forEach(i=>{h+=`<tr><td>${o.date||'N/A'}</td><td>${o.orderCode}</td><td title="${i.productName}"><a href="${i.productUrl||'#'}" target="_blank" class="item-link">${i.productName}</a></td><td style="text-align:right">${i.quantity||'N/A'}</td><td style="text-align:right">â‚©${Math.round(i.amount).toLocaleString()}</td></tr>`});h+=`<tr class="subtotal-row"><td colspan="4"><strong>'${o.orderCode}' ì†Œê³„:</strong></td><td style="text-align:right"><strong>â‚©${Math.round(o.artistTotalAmount).toLocaleString()}</strong></td></tr>`});
      h+='</tbody></table></div>';b.innerHTML=h;
  }
  function showArtistModalError(error){ const b = document.getElementById('artist-modal-body');
 if(b) b.innerHTML = `<p class="error-message">ì˜¤ë¥˜: ${error.toString()}</p>`; }
  function closeArtistModal(){ const m = document.getElementById('artist-orders-modal'); if(m) m.style.display = 'none';
 }

  // --- CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ ---
  function downloadActivityList(status, cardElement) {
      const originalHtml = cardElement.innerHTML;
 cardElement.innerHTML = '<h3>ë°ì´í„° ìƒì„± ì¤‘...</h3><div class="loader-small" style="margin: 1rem auto;"></div>';
      const countryFilter = document.getElementById('countryFilter').value;
      const dateRange = document.getElementById('dateRangeFilter').value;
 google.script.run
          .withSuccessHandler(csvData => {
              cardElement.innerHTML = originalHtml;
              // [ìˆ˜ì •] exportCustomerListByStatus í•¨ìˆ˜ê°€ code.gsì— ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë°œìƒ
              if (typeof csvData === 'undefined') {
                  showError("CSV export function not found or failed silently.");
       
        } else if (csvData.startsWith('Error:')) {
                  showError(csvData);
              } else {
                  const fileName = `${status.toLowerCase().replace(' ', '_')}_users_${countryFilter}_${dateRange}.csv`;
                  triggerCsvDownload(csvData, fileName);
             
  }
          })
          .withFailureHandler(error => { cardElement.innerHTML = originalHtml; showError(error); })
          .exportCustomerListByStatus(status, countryFilter);
 }
  function triggerCsvDownload(csvData, fileName) {
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
 const blob = new Blob([bom, csvData], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
 if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
 link.setAttribute("download", fileName);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      } else { navigator.msSaveBlob(blob, fileName);
 }
  }

  // --- ë¡œë” ìˆ¨ê¸°ê¸° ë° ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜ ---
  function hideLoaderAndShowContent(contentHiddenOnError = false) {
      const loader = document.getElementById('loader-container');
 const content = document.getElementById('analytics-content');
      if (loader) loader.style.display = 'none';
      if (content) {
          if (contentHiddenOnError && !document.querySelector('.error-card')) {
              content.classList.add('initially-hidden');
 } else {
              content.classList.remove('initially-hidden');
 }
      }
  }

  function showError(error) {
      console.error('ë¶„ì„ í˜ì´ì§€ ì˜¤ë¥˜:', error);
 hideLoaderAndShowContent(true); // ì˜¤ë¥˜ ì¹´ë“œ í‘œì‹œë¥¼ ìœ„í•´ ì½˜í…ì¸  ì˜ì—­ ë³´ì´ê¸°
      const content = document.getElementById('analytics-content');
 if (content) {
          content.classList.remove('initially-hidden');
 // Ensure content area is visible
          content.innerHTML = `<div class="card error-card" style="margin-top: 1rem;">
                                <h3><span style="color:var(--danger-color); margin-right: 0.5em;">âš ï¸</span> ë¶„ì„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</h3>
                                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
   
                              <p class="error-details">${error.toString()}</p>
                               </div>`;
 } else {
          const loaderContainer = document.getElementById('loader-container');
 if (loaderContainer) {
              loaderContainer.innerHTML = `<p class="error-message">í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ${error.toString()}</p>`;
 }
      }
  }
</script>

<style>
    /* Tab Styles */
    .tab-buttons {
        border-bottom: 1px solid var(--border-color);
 background-color: transparent;
        box-shadow: none; border: none; padding: 0 !important;
        margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;
 }
    .tab-button {
        padding: 0.75rem 1.25rem; border: none; background-color: transparent;
 color: var(--text-muted-color); font-size: 1rem; font-weight: 500;
        cursor: pointer; border-bottom: 3px solid transparent;
        transition: color 0.2s ease, border-bottom-color 0.2s ease;
 white-space: nowrap;
    }
    .tab-button:hover { color: var(--secondary-color);
 }
    .tab-button.active {
        color: var(--primary-color);
        font-weight: 600;
        border-bottom-color: var(--primary-color);
 }
    .tab-panel { display: none; } /* JSë¡œ ì œì–´ */
    .tab-panel.active { display: block;
 animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);
 } to { opacity: 1; transform: translateY(0); } }

    /* Ranking table specific styles (Allow wrapping for name) */
    .ranking-table {
        table-layout: auto;
 /* [ê°œì„ ] ìë™ ë ˆì´ì•„ì›ƒ */
        width: 100%;
        min-width: 0;
 /* [ê°œì„ ] ìµœì†Œ ë„ˆë¹„ ì œê±° */
    }
    .ranking-table th:first-child, .ranking-table td:first-child { width: 50px;
 text-align: center; white-space: nowrap; } /* Rank */
    /* [ê°œì„ ] ì´ë¦„ ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ */
    .ranking-table th:nth-child(2),
    .ranking-table td:nth-child(2) {
        white-space: normal;
 /* ì¤„ë°”ê¿ˆ í—ˆìš© */
        word-break: break-word;
        vertical-align: top;
        width: auto;
 /* ìë™ ë„ˆë¹„ */
        min-width: 150px;
        overflow: visible;
 /* Prevent clipping */
        text-overflow: clip;
 /* No ellipsis needed */
    }
    /* [ê°œì„ ] ê°’ ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ */
    .ranking-table th:last-child,
    .ranking-table td:last-child {
        width: 130px;
 text-align: right;
        white-space: nowrap;
        vertical-align: top; /* [ê°œì„ ] ìƒë‹¨ ì •ë ¬ */
    }
    .ranking-table td small { font-size: 0.8em;
 color: var(--text-muted-color); margin-left: 2px; }
    .ranking-split-container {
        margin-top: 1rem;
 display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem 2rem;
    }
    .ranking-name-cell { /* Class added in populateRankingTable for consistency */ }
    
    /* [ì‚­ì œ] GeoChart ê´€ë ¨ ìŠ¤íƒ€ì¼ ì œê±° */


    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
 }
        .analytics-grid { grid-template-columns: 1fr; gap: 1rem;
 }
        .ranking-split-container { grid-template-columns: 1fr;
 }
        .chart-container { height: 250px !important;
 }
        /* [ìˆ˜ì •] regional chart ë†’ì´ ëª¨ë°”ì¼ ëŒ€ì‘ */
        #regional-performance-chart-container { height: 350px !important; }
        
        .card h3 { font-size: 1rem;
 }
        .card .value { font-size: 1.5rem;
 }
        .crm-table .col-recency small { display: none;
 } /* R (ì¼ ì „) ìˆ¨ê¸°ê¸° */
        .modal-grid { grid-template-columns: 1fr;
 } /* ëª¨ë‹¬ ê·¸ë¦¬ë“œ 1ì—´ */
    }
    @media (max-width: 480px) {
        .container { padding: 0 var(--spacing-sm);
 }
        .page-content { padding: var(--spacing-md);
 }
        .section-title { font-size: 1.25rem; margin-bottom: 1rem;
 }
        .tab-button { padding: 0.5rem 0.75rem; font-size: 0.9rem;
 }
        .kpi-grid { grid-template-columns: 1fr 1fr;
 }
        .card { padding: var(--spacing-md);
 }
        .table th, .table td { padding: 0.5rem 0.6rem; font-size: var(--font-size-xs);
 }
        .table th { font-size: 10px;
 }
        .ranking-table th:last-child, .ranking-table td:last-child { width: 100px;
 }
        /* CRM í…Œì´ë¸” ëª¨ë°”ì¼ ê°€ë…ì„± ê°œì„  (ì˜ˆ: ì¼ë¶€ ì»¬ëŸ¼ ìˆ¨ê¸°ê¸°) */
        .crm-table .col-country, .crm-table .col-artist-diversity, .crm-table .col-first-count { display: none;
 }
        .crm-table .col-user-id { width: 25%;
 }
        .crm-table .col-name { width: 30%;
 }
        .crm-table .col-status { width: 20%;
 }
        .crm-table .col-monetary, .crm-table .col-frequency, .crm-table .col-recency, .crm-table .col-first-amount, .crm-table .col-first-date { width: 25%;
 }
    }
</style>
</body>
</html>