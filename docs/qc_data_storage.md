# QC 데이터 저장 및 동기화 가이드

## 📊 현재 데이터 저장 구조

### 데이터 저장 위치

QC 데이터는 **이중 저장 구조**를 사용합니다:

1. **서버 메모리 (qcDataStore)** - 빠른 접근을 위한 캐시
   - 위치: `backend/src/routes/qc.ts`의 `qcDataStore` 객체
   - 타입: `Map<string, QCItem>`
   - 용도: 실시간 조회 및 빠른 상태 업데이트

2. **Google Sheets** - 영구 저장소
   - 원본 데이터: `1.설명글_한글_raw`, `1.OCR_결과_raw`
   - 처리 중 데이터: `텍스트 QC & 이미지 QC`
   - 아카이브: `3.QC 완료 / 작가푸시`

---

## 🔄 데이터 동기화 흐름

### 1. 서버 시작 시
```
Google Sheets → 서버 메모리 (qcDataStore)
```
- 서버가 시작될 때 `initializeQCData()` 함수가 실행됩니다
- Google Sheets에서 데이터를 읽어와 메모리에 로드합니다
- 작가 정보, 텍스트 QC, 이미지 QC, 아카이브 데이터를 모두 로드합니다

### 2. CSV 업로드 시
```
CSV 파일 → 서버 메모리 (qcDataStore)
```
- CSV 파일을 업로드하면 메모리에만 저장됩니다
- **주의**: 현재는 Google Sheets에 자동 저장되지 않습니다
- 서버 재시작 시 업로드한 데이터가 사라질 수 있습니다

### 3. QC 상태 업데이트 시
```
사용자 액션 → 서버 메모리 업데이트 → Google Sheets 업데이트 (비동기)
```
- 승인/수정 필요/비대상 상태 변경 시:
  1. 먼저 메모리(`qcDataStore`)에 저장
  2. 그 다음 Google Sheets에 상태 업데이트 (비동기)
  3. Google Sheets 저장 실패해도 메모리 업데이트는 유지

### 4. QC 완료 처리 시
```
사용자 액션 → 서버 메모리 (아카이브로 이동) → Google Sheets 아카이브 시트에 저장 (비동기)
```
- 완료 처리 시:
  1. 메모리에서 활성 QC에서 아카이브로 이동
  2. Google Sheets 아카이브 시트에 저장 (비동기)

---

## ⚠️ 현재 제한사항 및 주의사항

### 1. 데이터 지속성 문제
- **문제**: 서버 재시작 시 메모리 데이터가 사라집니다
- **현재 동작**:
  - 서버 시작 시 Google Sheets에서 데이터를 로드합니다
  - 하지만 CSV 업로드로 추가된 데이터는 Google Sheets에 저장되지 않습니다
  - 따라서 CSV 업로드 후 서버가 재시작되면 업로드한 데이터가 사라질 수 있습니다

### 2. 다중 사용자 지원
- **현재 상태**: ✅ 지원됨
- 같은 서버를 사용하는 모든 사용자가 동일한 데이터를 볼 수 있습니다
- 한 사용자가 상태를 변경하면 다른 사용자도 즉시 반영됩니다 (페이지 새로고침 시)

### 3. 데이터 초기화
- **페이지를 열 때마다**: ❌ 초기화되지 않음
- **서버 재시작 시**: ⚠️ CSV 업로드 데이터는 사라질 수 있음
- **Google Sheets 데이터**: ✅ 유지됨

---

## 🔧 개선 사항 (구현 완료)

### 1. Google Sheets 쓰기 권한 추가
- Google Sheets Service에 쓰기 스코프 추가
- `appendRow()`, `appendRows()`, `findRowByColumn()` 메서드 추가

### 2. 상태 업데이트 시 Google Sheets 저장
- `saveQCStatusToSheets()` 함수 추가
- 상태 변경 시 Google Sheets에 자동 저장 (비동기)

### 3. 완료 처리 시 아카이브 저장
- `saveToArchiveSheet()` 함수 추가
- 완료 처리 시 아카이브 시트에 자동 저장 (비동기)

---

## 📝 향후 개선 필요 사항

### 1. CSV 업로드 시 Google Sheets 저장
**현재 문제**:
- CSV 업로드 시 메모리에만 저장됨
- 서버 재시작 시 데이터 손실 가능

**개선 방안**:
- CSV 업로드 시 Google Sheets 원본 시트에 자동 저장
- 또는 처리 시트에 추가

### 2. Google Sheets 컬럼 구조 매핑
**현재 문제**:
- `saveQCStatusToSheets()` 함수에서 컬럼 위치가 하드코딩됨 (Z, AA, AB)
- 실제 시트 구조에 맞게 조정 필요

**개선 방안**:
- 시트 헤더를 읽어서 동적으로 컬럼 위치 찾기
- 또는 설정 파일에 컬럼 매핑 정의

### 3. 데이터베이스 마이그레이션
**장기적 개선**:
- 메모리 저장소 대신 데이터베이스 사용 (PostgreSQL, MongoDB 등)
- 또는 Redis 사용 (캐시 + 영구 저장)

---

## 🎯 사용자 가이드

### 데이터가 유지되는 경우
✅ Google Sheets에 이미 있는 데이터
✅ 서버 시작 시 Google Sheets에서 로드된 데이터
✅ 상태 업데이트 (승인/수정 필요/비대상) - Google Sheets에 저장됨
✅ 완료 처리 - 아카이브 시트에 저장됨

### 데이터가 사라질 수 있는 경우
⚠️ CSV 업로드 후 서버 재시작 전에 완료하지 않은 항목
⚠️ 서버 재시작 시 메모리에만 있는 데이터

### 권장 사용 방법
1. CSV 업로드 후 가능한 빨리 QC 진행
2. 완료 처리된 항목은 아카이브에 저장되므로 안전함
3. 정기적으로 서버를 재시작하지 않도록 주의
4. 중요한 데이터는 Google Sheets에 직접 추가하는 것을 권장

---

## 🔍 데이터 확인 방법

### Google Sheets에서 확인
1. `텍스트 QC & 이미지 QC` 시트: 현재 처리 중인 QC 항목
2. `3.QC 완료 / 작가푸시` 시트: 완료된 QC 항목
3. `1.설명글_한글_raw`, `1.OCR_결과_raw`: 원본 데이터

### 서버 로그에서 확인
- 서버 시작 시: `[QC] QC 데이터 초기화 시작...`
- 데이터 로드: `[QC] 텍스트 QC 데이터 로드 완료: X개 가져옴`
- 상태 저장: `[QC] Google Sheets 상태 저장 실패:` (실패 시에만)

---

**마지막 업데이트**: 2025-01-XX
**작성자**: AI Assistant







