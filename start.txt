<div class="container">
  <h1>ğŸš¨ ë¯¸ì…ê³  ê´€ë¦¬ (V10.40)</h1>
  <p style="color: var(--text-muted-color); margin-top: -8px; margin-bottom: 24px;">
    'ê²°ì œ ì™„ë£Œ' ìƒíƒœì˜ ì£¼ë¬¸ ì¤‘ 'ì²˜ë¦¬ì™„ë£Œ'ë˜ì§€ ì•Šì€ ê°œë³„ ì‘í’ˆ ëª©ë¡ì…ë‹ˆë‹¤.
  </p>

  <div class="kpi-grid">
    <div class="card"><h3>ì´ ë¯¸ì…ê³  ì‘í’ˆ</h3><p id="kpi-total" class="value">0 <small>ê°œ</small></p></div>
    <div class="card"><h3>ê´€ë ¨ ì£¼ë¬¸</h3><p id="kpi-orders" class="value">0 <small>ê±´</small></p></div>
    <div class="card"><h3>ê´€ë ¨ ì‘ê°€</h3><p id="kpi-artists" class="value">0 <small>ëª…</small></p></div>
    <div class="card"><h3>ğŸš¨ <span id="kpi-threshold">7</span>ì¼ ì´ìƒ ì§€ì—°</h3><p id="kpi-delayed" class="value warning">0 <small>ê°œ</small></p></div>
  </div>

  <div class="global-filters card">
  
  <div class="filter-group" style="flex-grow: 1;"> <label for="searchInput">ê²€ìƒ‰</label>
    <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="ì£¼ë¬¸ë²ˆí˜¸, ì‘ê°€ëª…, ì‘í’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰...">
  </div>

  <div class="filter-group">
    <label for="delayFilter">ì§€ì—° ìƒíƒœ</label>
    <select id="delayFilter" onchange="applyFilters()">
      <option value="all">ëª¨ë“  ì§€ì—° ìƒíƒœ</option>
      <option value="delayed">7ì¼ ì´ìƒ ì§€ì—°</option>
    </select>
  </div>

  <div class="filter-group">
    <label for="bundleFilter">ì£¼ë¬¸ ìœ í˜•</label>
    <select id="bundleFilter" onchange="applyFilters()">
      <option value="all">ëª¨ë“  ì£¼ë¬¸ ìœ í˜•</option>
      <option value="bundle">ë¬¶ìŒ ì£¼ë¬¸ (2ëª… ì´ìƒ ì‘ê°€)</option>
      <option value="single">ë‹¨ì¼ ì£¼ë¬¸ (ì‘ê°€ 1ëª…)</option>
    </select>
  </div>

</div>

  <div id="loader-container"><?!= include('loading'); ?></div>

  <div id="unreceived-content" class="table-container initially-hidden">
    <table id="unreceived-table" class="table">
      <thead>
        <tr>
          <th class="col-order-code">ì£¼ë¬¸ë²ˆí˜¸</th>
          <th class="col-artist-name">ì‘ê°€ëª…</th>
          <th class="col-product-name">ì‘í’ˆëª… (ì£¼ë¬¸ ë‚´ í˜„í™©)</th>
          <th class="col-date">ì£¼ë¬¸ì¼</th>
          <th class="col-days">ê²½ê³¼ì¼</th>
          <th class="col-status">í˜„ì¬ ë©”ëª¨</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
</div>

<div id="memo-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="memo-modal-title">ë©”ëª¨ ìˆ˜ì •</h2>
      <button class="modal-close" onclick="closeMemoModal()">&times;</button>
    </div>
    <div class="modal-body">
      <textarea id="memo-textarea" placeholder="ì²˜ë¦¬ ìƒíƒœ ë©”ëª¨ ì…ë ¥..."></textarea>
      <p class="current-status-text" style="margin-top: 8px;">
        <strong>í˜„ì¬ ë©”ëª¨:</strong> <span id="current-memo-text"></span>
      </p>
    </div>
    <div class="modal-footer">
      <button class="action-button" id="save-memo-button" onclick="saveMemo()">ì €ì¥</button>
      </div>
  </div>
</div>

<script>
  let allUnreceivedData = [];
  let currentEditingOrderCode = null;

  document.addEventListener("DOMContentLoaded", function() {
    google.script.run
      .withSuccessHandler(initializePage)
      .withFailureHandler(showError)
      .getUnreceivedItemsData();
  });

  function initializePage(data) {
    if (data.error) {
      showError(data.error);
      return;
    }
    const kpis = data.kpis || {};
    document.getElementById('kpi-total').innerHTML = `${(kpis.total || 0).toLocaleString()} <small>ê°œ</small>`;
    document.getElementById('kpi-orders').innerHTML = `${(kpis.orders || 0).toLocaleString()} <small>ê±´</small>`;
    document.getElementById('kpi-artists').innerHTML = `${(kpis.artists || 0).toLocaleString()} <small>ëª…</small>`;
    document.getElementById('kpi-delayed').innerHTML = `${(kpis.delayed || 0).toLocaleString()} <small>ê°œ</small>`;
    document.getElementById('kpi-threshold').textContent = kpis.threshold || 7;
    if (kpis.delayed > 0) {
      document.getElementById('kpi-delayed').classList.add('warning');
    } else {
      document.getElementById('kpi-delayed').classList.remove('warning');
    }
    allUnreceivedData = data.items || [];
    allUnreceivedData.sort((a, b) => b.daysElapsed - a.daysElapsed);
    populateTable(allUnreceivedData);
    document.getElementById('loader-container').style.display = 'none';
    document.getElementById('unreceived-content').classList.remove('initially-hidden');
  }

  function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const delayFilter = document.getElementById('delayFilter').value;
    const bundleFilter = document.getElementById('bundleFilter').value;
    let filteredData = allUnreceivedData;
    if (searchTerm) {
      filteredData = filteredData.filter(item =>
        item.orderCode.toLowerCase().includes(searchTerm) ||
        item.artistName.toLowerCase().includes(searchTerm) ||
        item.productName.toLowerCase().includes(searchTerm)
      );
    }
    if (delayFilter === 'delayed') {
      const threshold = parseInt(document.getElementById('kpi-threshold').textContent || 7);
      filteredData = filteredData.filter(item => item.daysElapsed >= threshold);
    }
    if (bundleFilter === 'bundle') {
      filteredData = filteredData.filter(item => item.isBundle === true);
    } else if (bundleFilter === 'single') {
      filteredData = filteredData.filter(item => item.isBundle === false);
    }
    populateTable(filteredData);
  }

  // â–¼â–¼â–¼â–¼â–¼ [ìˆ˜ì •ë¨] DOM APIë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ (SyntaxError í•´ê²°) â–¼â–¼â–¼â–¼â–¼
  function populateTable(data) {
    const tableBody = document.getElementById('unreceived-table').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ''; // Clear previous table data

    if (data.length === 0) {
      // Display message if no data matches filters
      tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }

    data.forEach(row => {
      let newRow = tableBody.insertRow();

      // Apply row highlighting based on delay
      if (row.daysElapsed >= 10) { newRow.className = 'status-danger'; }
      else if (row.daysElapsed >= 7) { newRow.className = 'status-warning'; }

      // 1. Order Code Cell
      let cellOrderCode = newRow.insertCell();
      cellOrderCode.className = 'col-order-code';
      cellOrderCode.textContent = row.orderCode;

      // 2. Artist Name Cell
      let cellArtist = newRow.insertCell();
      cellArtist.className = 'col-artist-name';
      cellArtist.textContent = row.artistName;

      // 3. Product Name (with Bundle Tooltip) Cell
      let cellProduct = newRow.insertCell();
      // Apply tooltip class to TD for overflow fix
      cellProduct.className = 'col-product-name cell-with-tooltip';

      // Separate product name span and bundle container div for vertical stacking
      let productNameHtml = `<span class="product-name-cell" title="${row.productName}">${row.productName}</span>`;
      let bundleContainerHtml = ''; // Initialize bundle container HTML

      // Generate bundle badge and tooltip HTML if applicable
      if (row.isBundle && row.allItems && row.allItems.length > 0) {
        let tooltipItemsHtml = '';
        row.allItems.forEach(item => {
          const statusClass = item.status === 'ì…ê³ ì™„ë£Œ' ? 'status-received' : 'status-unreceived';
          tooltipItemsHtml += `<li class="${statusClass}"><strong>${item.productName}</strong><br><small>by ${item.artistName}</small></li>`;
        });

        // Use the structure defined in (updated) table_styles.txt
        bundleContainerHtml = `
          <div class="bundle-container">
            <span class="bundle-badge" title="ì´ ì£¼ë¬¸ì€ ì—¬ëŸ¬ ì‘ê°€ì˜ ì‘í’ˆì„ í¬í•¨í•©ë‹ˆë‹¤.">ë¬¶ìŒ (${row.allItems.length}ê°œ)</span>
            <div class="bundle-tooltip">
              <strong>'${row.orderCode}' ì£¼ë¬¸ í˜„í™©</strong>
              <ul>${tooltipItemsHtml}</ul>
            </div>
          </div>`;
      }
      // Combine the name span and bundle container vertically
      cellProduct.innerHTML = productNameHtml + bundleContainerHtml;

      // 4. Order Date Cell
      let cellDate = newRow.insertCell();
      cellDate.className = 'col-date';
      cellDate.textContent = row.orderDate;

      // 5. Days Elapsed Cell
      let cellDays = newRow.insertCell();
      cellDays.className = 'col-days';
      cellDays.textContent = `${row.daysElapsed} ì¼`;

      // 6. Status/Memo Cell
      let cellStatus = newRow.insertCell();
      cellStatus.className = 'col-status';

      // --- [ìˆ˜ì •] DOM APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì…€ ì»¨í…ì¸  ìƒì„± ---
      
      // 6.1. ì»¨í…Œì´ë„ˆ div ìƒì„±
      const flexDiv = document.createElement('div');
      flexDiv.style.display = 'flex';
      flexDiv.style.justifyContent = 'space-between';
      flexDiv.style.alignItems = 'center';
      flexDiv.style.gap = '8px';

      // 6.2. ë©”ëª¨ í…ìŠ¤íŠ¸ span ìƒì„±
      const memoSpan = document.createElement('span');
      memoSpan.className = 'current-status-text';
      memoSpan.title = row.currentStatus || '';
      memoSpan.style.flexGrow = '1';
      memoSpan.style.overflow = 'hidden';
      memoSpan.style.textOverflow = 'ellipsis';
      memoSpan.style.whiteSpace = 'nowrap';
      memoSpan.textContent = row.currentStatus || 'ë©”ëª¨ ì—†ìŒ';

      // 6.3. ìˆ˜ì • ë²„íŠ¼ ìƒì„±
      const editButton = document.createElement('button');
      editButton.className = 'action-button memo-button';
      editButton.textContent = 'ìˆ˜ì •';
      
      // 6.4. [í•µì‹¬] dataset APIë¡œ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥
      editButton.dataset.memo = row.currentStatus || '';
      
      // 6.5. [í•µì‹¬] addEventListenerë¡œ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      editButton.addEventListener('click', function(event) {
        event.stopPropagation();
        // 'this' (í´ë¦­ëœ ë²„íŠ¼)ì™€ orderCodeë¥¼ ëª¨ë‹¬ í•¨ìˆ˜ë¡œ ì „ë‹¬
        openMemoModal(this, row.orderCode); 
      });

      // 6.6. ìƒì„±ëœ ìš”ì†Œë“¤ì„ ì…€ì— ì¶”ê°€
      flexDiv.appendChild(memoSpan);
      flexDiv.appendChild(editButton);
      cellStatus.appendChild(flexDiv);
      // --- [ìˆ˜ì •] DOM API ì‚¬ìš© ë ---
    });
  }
  // â–²â–²â–²â–²â–² [ìˆ˜ì •ë¨] populateTable í•¨ìˆ˜ ë â–²â–²â–²â–²â–²


  // â–¼â–¼â–¼â–¼â–¼ [ìˆ˜ì •ë¨] JSON.parse()ë¥¼ ì œê±°í•˜ê³  dataset.memoë¥¼ ì§ì ‘ ì½ë„ë¡ ë³€ê²½ â–¼â–¼â–¼â–¼â–¼
  function openMemoModal(buttonElement, orderCode) {
    // [ìˆ˜ì •] dataset.memoì—ì„œ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì½ì–´ì˜µë‹ˆë‹¤.
    const currentMemo = buttonElement.dataset.memo;

    currentEditingOrderCode = orderCode;
    document.getElementById('memo-modal-title').textContent = `${orderCode} ë©”ëª¨ ìˆ˜ì •`;
    document.getElementById('current-memo-text').textContent = currentMemo || 'ë©”ëª¨ ì—†ìŒ';
    document.getElementById('memo-textarea').value = currentMemo || ''; // nullì¼ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ
    document.getElementById('memo-modal').style.display = 'flex';
    document.getElementById('memo-textarea').focus();
  }
  // â–²â–²â–²â–²â–² [ìˆ˜ì •ë¨] openMemoModal í•¨ìˆ˜ ë â–²â–²â–²â–²â–²

  function closeMemoModal() {
    document.getElementById('memo-modal').style.display = 'none';
    currentEditingOrderCode = null;
  }

  function saveMemo() {
    if (!currentEditingOrderCode) return;
    const button = document.getElementById('save-memo-button');
    // const spinner = document.getElementById('save-spinner'); // UX Suggestion
    const newMemo = document.getElementById('memo-textarea').value;
    button.disabled = true;
    button.textContent = 'ì €ì¥ ì¤‘...';
    // if (spinner) spinner.style.display = 'inline-block'; // UX Suggestion

    google.script.run
      .withSuccessHandler(function(response) {
        button.disabled = false;
        button.textContent = 'ì €ì¥';
        // if (spinner) spinner.style.display = 'none'; // UX Suggestion

        if (response.status === 'success') {
          allUnreceivedData.forEach(item => {
            if (item.orderCode === currentEditingOrderCode) {
              item.currentStatus = newMemo;
            }
          });
          applyFilters();
          closeMemoModal();
          // UX Suggestion: Show toast notification here
          // showToast('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('ì˜¤ë¥˜: ' + response.message);
        }
      })
      .withFailureHandler(function(error) {
        button.disabled = false;
        button.textContent = 'ì €ì¥';
        // if (spinner) spinner.style.display = 'none'; // UX Suggestion
        alert('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ: ' + error.toString());
      })
      .updateProcessingStatus(currentEditingOrderCode, newMemo);
  }

  // UX Suggestion: Add a function for toast notifications
  /*
  function showToast(message) {
    // Implementation for showing a temporary message overlay
  }
  */

  function showError(error) {
    console.error('Error fetching unreceived data:', error);
    document.getElementById('loader-container').style.display = 'none';
    document.getElementById('unreceived-content').classList.remove('initially-hidden');
    const tableBody = document.getElementById('unreceived-table').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding: 2rem;">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.toString()}</td></tr>`;
  }
</script>

<style>
  /* â–¼â–¼â–¼â–¼â–¼ [ì‚­ì œë¨] ë ˆì´ì•„ì›ƒ ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¤ëŠ” CSS ê·œì¹™ â–¼â–¼â–¼â–¼â–¼ */
  /*
  #unreceived-content.table-container {
      overflow-x: visible; 
  }
  #unreceived-table {
      table-layout: auto; 
      min-width: 0;
  }
  */
  /* â–²â–²â–²â–²â–² [ì‚­ì œë¨] ì—¬ê¸°ê¹Œì§€ â–²â–²â–²â–²â–² */


  /* [ë¦¬íŒ©í† ë§] íˆ´íŒì´ ë±ƒì§€ 'ì•„ë˜'ë¡œ ë‚˜ì˜¤ë„ë¡ table_styles.txt ë®ì–´ì“°ê¸° */
  .bundle-tooltip {
      bottom: auto; /* ê¸°ì¡´ bottom ì†ì„± ë¬´íš¨í™” */
      top: 100%;    /* ë±ƒì§€ ì•„ë˜ë¡œ í¼ì¹˜ê¸° */
      margin-bottom: 0; /* ê¸°ì¡´ margin-bottom ë¬´íš¨í™” */
      margin-top: 8px;  /* ë±ƒì§€ì™€ì˜ ê°„ê²© */
      z-index: 20;  /* ë‹¤ë¥¸ ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ z-index ë³´ì¥ */
  }

  /* [ë¦¬íŒ©í† ë§] íˆ´íŒ í™”ì‚´í‘œ ì¶”ê°€ (ìœ„ë¥¼ í–¥í•˜ë„ë¡) */
  .bundle-tooltip::after {
      content: "";
      position: absolute;
      bottom: 100%; /* íˆ´íŒì˜ ìƒë‹¨ */
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      /* table_styles.txtì˜ íˆ´íŒ ë°°ê²½ìƒ‰(var(--secondary-color))ì„ ë”°ë¼ê° */
      border-color: transparent transparent var(--secondary-color) transparent;
  }
  
  /* [ë¦¬íŒ©í† ë§] ë‹¤í¬ ëª¨ë“œ íˆ´íŒ í™”ì‚´í‘œ ìƒ‰ìƒ ë®ì–´ì“°ê¸° */
  [data-theme="dark"] .bundle-tooltip::after {
      /* table_styles.txtì˜ ë‹¤í¬ëª¨ë“œ íˆ´íŒ ë°°ê²½ìƒ‰(var(--card-background-color))ì„ ë”°ë¼ê° */
      border-color: transparent transparent var(--card-background-color) transparent;
  }

  /* --- ê¸°ì¡´ start.txt ìŠ¤íƒ€ì¼ (ìœ ì§€) --- */
  #kpi-total small, #kpi-orders small, #kpi-artists small, #kpi-delayed small {
    font-size: 0.7em;
 color: var(--text-muted-color);
    margin-left: 0.2em;
  }
  #kpi-delayed.warning {
      color: var(--warning-color);
 }

  /* Column widths (ensure these match or override table_styles.txt if needed) */
  #unreceived-table .col-order-code { width: 15%; }
  #unreceived-table .col-artist-name { width: 15%; }
  #unreceived-table .col-product-name { width: 30%;}
  #unreceived-table .col-date { width: 12%; text-align: center; }
  #unreceived-table .col-days { width: 10%; text-align: right; }
  #unreceived-table .col-status { width: 18%; }

  /* UX Suggestion: Increase row padding */
  /*
  #unreceived-table th, #unreceived-table td {
    padding-top: 0.9rem; padding-bottom: 0.9rem;
  }
  */

  /* UX Suggestion: Highlight delayed days cell */
  /*
  #unreceived-table td.col-days { font-weight: 500; }
  #unreceived-table tr.status-warning td.col-days { background-color: rgba(243, 156, 18, 0.1); }
  #unreceived-table tr.status-danger td.col-days { background-color: rgba(231, 76, 60, 0.1); font-weight: bold; }
  */

</style>